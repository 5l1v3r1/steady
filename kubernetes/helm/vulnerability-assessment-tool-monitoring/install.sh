#!/bin/sh
if [ -z $STERN_VERSION ]; then
  STERN_VERSION="1.11.0"
fi

if [ -z $WRAPPER_DIR ]; then
  WRAPPER_DIR="/vulas/stern"
fi

_install_log() {
  echo `date "+%Y:%m:%d-%H:%M:%S"` "$1" "\033[0m: $2"
}

_install_info() {
  if [[ -z $INSTALL_DEBUG ]]; then
    _install_log "[info]" "$1"
  fi
}
_install_warn() {
  _install_log "\e[1;33m[warning]" "$1"
}
_install_error() {
  _install_log "\e[1;31m[error]" "$1"
}
_install_success() {
  _install_log "\e[1;32m[success]" "$1"
}

_check_curl() {
  if hash curl 2>/dev/null; then
    _install_success "curl installation found"
  else
    _install_warn "curl installation not found"
    _install_log "installing curl"

    apk add --no-cache curl \
    ca-certificates
  fi
}


_check_stern() {
  if hash stern 2>/dev/null; then
    _install_success "stern installation found"
  else
    _install_warn "stern installation not found "

    cd /tmp/
    curl -LO https://github.com/wercker/stern/releases/download/$STERN_VERSION/stern_linux_amd64
    chmod +x /tmp/stern_linux_amd64
    mv /tmp/stern_linux_amd64 /usr/local/bin/stern
    _install_success "stern has been added to path"
  fi
}


_add_wrapper() {
  _check_curl
  _check_stern

  if [ -f $WRAPPER_DIR/stern.sh ]; then
    chmod +x $WRAPPER_DIR/stern.sh
    mv $WRAPPER_DIR/stern.sh /usr/local/bin/stern.sh
  fi
}

_add_wrapper
exec "$@"
